# vault-agent/templates/init-user.sql.ctmpl
# Add `tf-postgres-user` in the template too so that no need to create the user manually later using ./scripts/create-user.sh
{{ with secret "secret/data/postgres/auth" }}
DO $$
BEGIN
  IF NOT EXISTS (
    SELECT FROM pg_roles WHERE rolname = '{{ .Data.data.username }}'
  ) THEN
    CREATE ROLE superadmin WITH LOGIN PASSWORD '{{ .Data.data.password }}' SUPERUSER;
  ELSE
    ALTER ROLE superadmin WITH PASSWORD '{{ .Data.data.password }}';
  END IF;
END $$;
{{ end }}